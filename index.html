<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finance Pulse</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">ðŸ“Š Finance Pulse</h1>
    <div id="alerts" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6"></div>
    <div id="chart-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-lg p-4 max-w-xl w-full">
        <button onclick="closeChart()" class="mb-2 px-2 py-1 bg-red-600 text-white rounded">Close</button>
        <canvas id="chartCanvas" height="200"></canvas>
      </div>
    </div>
    <section class="mb-6">
      <h2 class="text-xl font-semibold">Latest Headlines</h2>
      <ul id="news-list" class="list-disc list-inside text-sm space-y-1"></ul>
    </section>
    <div id="mode-box" class="p-4 rounded-lg text-lg font-bold text-center bg-yellow-500">Loading...</div>
  </div>

<script>
const FMP_KEY = 'wBaK2cIhxa1C7tg5D3NpSu9CduOCbvgF';
const MA_TOKEN = 'oVD1aAOfz57uhiKUUYS3DWw3RFFWQjjpOHLOAkzl';

const indicators = [
  { name: 'S&P 500', symbol: 'SPY' },
  { name: 'Nasdaq 100', symbol: 'QQQ' },
  { name: 'Gold', symbol: 'XAUUSD' },
  { name: '10Y Yield', symbol: 'IEF' },
  { name: 'Dollar (UUP)', symbol: 'UUP' },
  { name: 'Fear & Greed', symbol: 'feargreed', type: 'sentiment' }
];

async function fetchFmp(symbol) {
  const res = await fetch(`https://financialmodelingprep.com/api/v3/quote/${symbol}?apikey=${FMP_KEY}`);
  const j = await res.json();
  if (Array.isArray(j) && j.length) return j[0];
  throw new Error('No data');
}

async function fetchSentiment() {
  const res = await fetch('https://api.alternative.me/fng/?limit=1');
  const j = await res.json();
  const d = j.data?.[0];
  return { value: +d.value, sentiment: d.value_classification };
}

function determineRisk(item) {
  if (item.type === 'sentiment') return item.value < 30 ? 'risk-off' : 'neutral';
  if (item.symbol === 'SPY' && item.price < 430) return 'risk-off';
  if (item.symbol === 'QQQ' && item.price < 350) return 'risk-off';
  if (item.symbol === 'IEF' && item.price < 90) return 'risk-off';
  if (item.symbol === 'XAUUSD' && item.price < 1900) return 'risk-off';
  if (item.symbol === 'UUP' && item.price > 30) return 'risk-off';
  return 'neutral';
}

async function loadData() {
  const data = [];
  for (const i of indicators) {
    try {
      if (i.type === 'sentiment') {
        const s = await fetchSentiment();
        data.push({ ...i, value: s.value, sentiment: s.sentiment });
      } else {
        const q = await fetchFmp(i.symbol);
        data.push({ ...i, price: q.price, change: q.changesPercentage });
      }
    } catch(e) {
      console.error(`Error fetching ${i.name}`, e);
      data.push(i.type === 'sentiment' ? { ...i, value:'N/A', sentiment:'' } : { ...i, price:'N/A', change:null });
    }
  }
  return data;
}

function renderAlerts(data) {
  const el = document.getElementById('alerts');
  el.innerHTML = '';
  data.forEach(d => {
    const risk = determineRisk(d);
    const bg = risk==='risk-off'? 'bg-red-500':'bg-yellow-500';
    const val = d.type==='sentiment'? d.value : (d.price==='N/A'? 'N/A': d.price.toFixed(2));
    const pct = d.change!=null ? `<div class="${d.change>=0?'text-green-600':'text-red-600'} text-sm">${d.change>=0?'+':''}${d.change.toFixed(2)}%</div>`:'';
    const sent = d.sentiment ? `<div class="text-gray-800 text-sm">${d.sentiment}</div>` : '';
    const card = document.createElement('div');
    card.className = `${bg} rounded p-4 text-black cursor-pointer`;
    card.innerHTML = `<div class="font-bold">${d.name}</div><div class="text-2xl">${val}</div>${pct}${sent}`;
    if (!d.type) card.onclick = ()=> showChart(d.name, d.symbol);
    el.appendChild(card);
  });
  renderMode(data);
}

function renderMode(data) {
  const count = data.filter(i => determineRisk(i)==='risk-off').length;
  const box = document.getElementById('mode-box');
  if (count>=3) {
    box.textContent='âš ï¸ High Risk';
    box.className='bg-red-500 p-4 rounded text-black text-lg font-bold text-center';
  } else if (count===0) {
    box.textContent='âœ… Stable';
    box.className='bg-green-500 p-4 rounded text-black text-lg font-bold text-center';
  } else {
    box.textContent='ðŸŸ¡ Mixed Signals';
    box.className='bg-yellow-500 p-4 rounded text-black text-lg font-bold text-center';
  }
}

async function showChart(name,symbol) {
  const modal = document.getElementById('chart-modal');
  modal.classList.remove('hidden');
  const res = await fetch(`https://financialmodelingprep.com/api/v3/historical-price-full/${symbol}?timeseries=30&apikey=${FMP_KEY}`);
  const j = await res.json();
  if (!j.historical) return;

  const ctx = document.getElementById('chartCanvas').getContext('2d');
  if(window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx, {
    type:'line',
    data:{labels:j.historical.map(a=>a.date).reverse(), datasets:[{label:name, data:j.historical.map(a=>a.close).reverse(), borderColor:'#3B82F6', backgroundColor:'#3B82F622'}]}
  });
}

function closeChart() {
  document.getElementById('chart-modal').classList.add('hidden');
}

async function loadNews() {
  try {
    const res = await fetch(`https://api.marketaux.com/v1/news/all?api_token=${MA_TOKEN}&limit=6`);
    const j = await res.json();
    const list = document.getElementById('news-list');
    list.innerHTML = '';
    j.data.forEach(a=>{
      const li = document.createElement('li');
      li.innerHTML=`<a href="${a.url}" target="_blank" class="underline hover:text-yellow-300">${a.title}</a>`;
      list.appendChild(li);
    });
  } catch(e) {
    console.error('News error', e);
  }
}

async function init() {
  const data = await loadData();
  renderAlerts(data);
  await loadNews();
}

init();
</script>
</body>
</html>
