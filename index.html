<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finance Pulse</title>
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">📊 Finance Pulse</h1>

    <!-- Market Alerts -->
    <section id="alerts" class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Market Pulse Alerts</h2>
      <div
        id="alert-cards"
        class="grid grid-cols-3 gap-4 cursor-pointer"
        title="Click an indicator for 1 month history"
      ></div>
    </section>

    <!-- Chart Container -->
    <section id="chart-section" class="mb-6 hidden">
      <h2 class="text-xl font-semibold mb-2" id="chart-title">Historical Chart</h2>
      <canvas id="history-chart" height="200"></canvas>
    </section>

    <!-- News Headlines -->
    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Latest Market Headlines</h2>
      <ul id="news-list" class="list-disc list-inside text-sm space-y-1"></ul>
    </section>

    <!-- Macro Snapshot -->
    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Macro Snapshot</h2>
      <div id="macro-panel" class="grid grid-cols-2 gap-4 text-sm"></div>
    </section>

    <!-- Mode Suggestion -->
    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Investment Mode</h2>
      <div
        id="mode-box"
        class="p-4 rounded-lg font-bold text-lg text-center bg-yellow-500 text-black"
      >
        Loading...
      </div>
    </section>
  </div>

  <script>
    const symbols = [
      { name: "S&P 500", symbol: "SPY", type: "etf", fmpSymbol: "SPY" },
      { name: "US 10Y Yield", symbol: "^TNX", type: "bond", fmpSymbol: "IEF" },
      { name: "Gold", symbol: "XAUUSD", type: "commodity", fmpSymbol: "XAUUSD" },
      { name: "Dollar Index", symbol: "DXY", type: "index", fmpSymbol: "DXY" },
      { name: "Nasdaq", symbol: "QQQ", type: "etf", fmpSymbol: "QQQ" },
      { name: "Put/Call Ratio", symbol: "put_call_ratio", type: "sentiment" },
    ];

    // Put/Call Ratio is from a public API endpoint

    const API_KEY = "wBaK2cIhxa1C7tg5D3NpSu9CduOCbvgF"; // replace with your Financial Modeling Prep API key
    const PUT_CALL_API = "https://www.cboe.com/api/global/daily_prices/put_call_ratio.csv";

    // Global chart instance so we can destroy before re-creating
    let historyChart = null;

    async function fetchPriceFMP(symbol) {
      try {
        const res = await fetch(
          `https://financialmodelingprep.com/api/v3/quote/${symbol}?apikey=${API_KEY}`
        );
        const json = await res.json();
        if (Array.isArray(json) && json.length > 0 && json[0].price) {
          return json[0].price;
        }
        return null;
      } catch (e) {
        console.error("FMP price fetch error for", symbol, e);
        return null;
      }
    }

    async function fetchPutCallRatio() {
      try {
        // This returns CSV data, so parse it:
        const res = await fetch(PUT_CALL_API);
        if (!res.ok) throw new Error("Failed to fetch put/call CSV");
        const text = await res.text();
        // The latest line is last line excluding header
        const lines = text.trim().split("\n");
        if (lines.length < 2) return null;
        const lastLine = lines[lines.length - 1];
        // CSV columns: Date,Put/Call Ratio,Volume
        const parts = lastLine.split(",");
        const ratio = parseFloat(parts[1]);
        return ratio;
      } catch (e) {
        console.error("Put/Call ratio fetch error", e);
        return null;
      }
    }

    async function fetchPrices() {
      const data = [];
      for (const s of symbols) {
        if (s.name === "Put/Call Ratio") {
          const val = await fetchPutCallRatio();
          data.push({ ...s, value: val });
        } else {
          const val = await fetchPriceFMP(s.fmpSymbol || s.symbol);
          data.push({ ...s, value: val });
        }
      }
      return data;
    }

    function determineRiskType(name, value) {
      if (name === "S&P 500" && value && value < 430) return "risk-off";
      if (name === "US 10Y Yield" && value && value > 3) return "risk-off";
      if (name === "Gold" && value && value < 1700) return "risk-off";
      if (name === "Dollar Index" && value && value < 100) return "risk-off";
      if (name === "Nasdaq" && value && value < 350) return "risk-off";
      if (name === "Put/Call Ratio" && value && value > 0.9) return "risk-off";
      return "neutral";
    }

    function renderLiveAlerts(data) {
      const container = document.getElementById("alert-cards");
      container.innerHTML = "";
      data.forEach((a) => {
        const riskType = determineRiskType(a.name, a.value);
        const bg =
          riskType === "risk-off"
            ? "bg-red-500"
            : riskType === "risk-on"
            ? "bg-green-500"
            : "bg-yellow-500";
        const displayValue =
          a.value !== null && a.value !== undefined
            ? typeof a.value === "number"
              ? a.value.toLocaleString(undefined, {
                  maximumFractionDigits: 2,
                })
              : a.value
            : "N/A";

        const card = document.createElement("div");
        card.className = `p-4 rounded-lg ${bg} text-black hover:opacity-80 transition-opacity`;
        card.title = "Click to view 1 month history";
        card.dataset.symbol = a.symbol;
        card.dataset.fmpSymbol = a.fmpSymbol || "";
        card.dataset.type = a.type;
        card.dataset.name = a.name;
        card.dataset.value = a.value;
        card.innerHTML = `
          <div class="text-sm font-bold">${a.name}</div>
          <div class="text-xl">${displayValue}</div>
        `;
        card.onclick = () => {
          loadHistoryChart(a);
        };
        container.appendChild(card);
      });

      renderModeSuggestion(data);
    }

    function renderModeSuggestion(alerts) {
      const modeBox = document.getElementById("mode-box");
      const riskOffCount = alerts.filter(
        (a) => determineRiskType(a.name, a.value) === "risk-off"
      ).length;
      if (riskOffCount >= 3) {
        modeBox.textContent =
          "⚠️ Caution: Consider Holding Cash or Rebalancing";
        modeBox.className =
          "p-4 rounded-lg font-bold text-lg text-center bg-red-500 text-black";
      } else if (riskOffCount === 0) {
        modeBox.textContent = "✅ Market Stable: Stay Invested";
        modeBox.className =
          "p-4 rounded-lg font-bold text-lg text-center bg-green-500 text-black";
      } else {
        modeBox.textContent = "🟡 Neutral: Stay Informed";
        modeBox.className =
          "p-4 rounded-lg font-bold text-lg text-center bg-yellow-500 text-black";
      }
    }

    async function fetchNews() {
      const FINNHUB_API_KEY = "d1482k1r01qrqeasm27gd1482k1r01qrqeasm280"; // Replace with your Finnhub key
      const url = `https://finnhub.io/api/v1/news?category=general&token=${FINNHUB_API_KEY}`;
      try {
        const r = await fetch(url);
        const j = await r.json();
        if (Array.isArray(j)) return j.slice(0, 5);
        else {
          console.error("News fetch unexpected response", j);
          return [];
        }
      } catch (e) {
        console.error("News fetch error", e);
        return [];
      }
    }

    function renderNewsHeadlines(articles) {
      const list = document.getElementById("news-list");
      list.innerHTML = "";
      articles.forEach((article) => {
        const li = document.createElement("li");
        li.classList.add("mb-1");
        li.innerHTML = `<a href="${article.url}" class="underline hover:text-yellow-300" target="_blank" rel="noopener noreferrer">${article.headline}</a>`;
        list.appendChild(li);
      });
    }

    async function loadHistoryChart(item) {
      const chartSection = document.getElementById("chart-section");
      const chartTitle = document.getElementById("chart-title");

      chartTitle.textContent = `${item.name} - Last 1 Month Performance`;
      chartSection.classList.remove("hidden");

      // Clear previous chart if any
      if (historyChart) {
        historyChart.destroy();
        historyChart = null;
      }

      // Fetch 1 month historical daily data from Financial Modeling Prep API
      if (item.name === "Put/Call Ratio") {
        // No historical data for sentiment - show message instead
        chartSection.innerHTML = `<h2 class="text-xl font-semibold mb-2">${item.name}</h2><p class="text-sm">Historical data not available for this indicator.</p>`;
        return;
      } else {
        chartSection.innerHTML = `<h2 class="text-xl font-semibold mb-2" id="chart-title">${item.name} - Last 1 Month Performance</h2><canvas id="history-chart" height="200"></canvas>`;
      }

      const symbol = item.fmpSymbol || item.symbol;
      const now = new Date();
      const past = new Date();
      past.setMonth(now.getMonth() - 1);

      const from = past.toISOString().slice(0, 10);
      const to = now.toISOString().slice(0, 10);

      try {
        const res = await fetch(
          `https://financialmodelingprep.com/api/v3/historical-price-full/${symbol}?from=${from}&to=${to}&apikey=${API_KEY}`
        );
        const json = await res.json();
        if (!json.historical) {
          chartSection.innerHTML +=
            "<p class='text-sm mt-2'>No historical data found.</p>";
          return;
        }

        const labels = json.historical
          .map((d) => d.date)
          .reverse();
        const prices = json.historical
          .map((d) => d.close)
          .reverse();

        const ctx = document.getElementById("history-chart").getContext("2d");
        historyChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: item.name,
                data: prices,
                borderColor: "rgba(239, 68, 68, 1)", // Tailwind red-500
                backgroundColor: "rgba(239, 68, 68, 0.2)",
                fill: true,
                tension: 0.3,
                pointRadius: 0,
              },
            ],
          },
          options: {
            scales: {
              x: {
                ticks: { color: "white" },
                grid: { color: "rgba(255,255,255,0.1)" },
              },
              y: {
                ticks: { color: "white" },
                grid: { color: "rgba(255,255,255,0.1)" },
              },
            },
            plugins: {
              legend: { labels: { color: "white" } },
            },
            responsive: true,
            maintainAspectRatio: false,
          },
        });
      } catch (e) {
        console.error("Error fetching historical data", e);
        chartSection.innerHTML +=
          "<p class='text-sm mt-2'>Failed to load historical data.</p>";
      }
    }

    async function fetchMacroSnapshot() {
      // We'll fetch just a few key macro indicators from FMP as a simple snapshot
      const macroSymbols = [
        { name: "US Unemployment Rate", symbol: "USURTOT", key: "value" },
        { name: "US CPI (MoM)", symbol: "CPIAUCSL", key: "value" },
        { name: "US GDP Annual Growth Rate", symbol: "GDP", key: "value" },
        { name: "US 2Y Treasury Yield", symbol: "DGS2", key: "value" },
      ];
      const panel = document.getElementById("macro-panel");
      panel.innerHTML = "";
      for (const m of macroSymbols) {
        try {
          // Note: These symbols may need to be adjusted for availability in FMP API or other sources
          // For demo, just show placeholder or skip
          panel.innerHTML += `<div class="p-2 bg-gray-800 rounded">${m.name}: N/A</div>`;
        } catch (e) {
          console.error("Error fetching macro data for", m.symbol, e);
          panel.innerHTML += `<div class="p-2 bg-gray-800 rounded">${m.name}: Error</div>`;
        }
      }
    }

    async function initDashboard() {
      const priceData = await fetchPrices();
      renderLiveAlerts(priceData);

      const newsArticles = await fetchNews();
      renderNewsHeadlines(newsArticles);

      await fetchMacroSnapshot();
    }

    initDashboard();
  </script>
</body>
</html>
