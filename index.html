<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Finance Pulse</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">ðŸ“Š Finance Pulse</h1>

    <!-- Market Alerts -->
    <section id="alerts" class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Market Pulse Alerts</h2>
      <div class="grid grid-cols-2 gap-4" id="alert-cards"></div>
    </section>

    <!-- Chart Display -->
    <section id="chart-section" class="mb-6 hidden">
      <h2 class="text-xl font-semibold mb-2" id="chart-title">Historical Chart</h2>
      <canvas id="chart-canvas" class="bg-white rounded-lg"></canvas>
    </section>

    <!-- News Headlines -->
    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Latest Market Headlines</h2>
      <ul id="news-list" class="list-disc list-inside text-sm space-y-1"></ul>
    </section>

    <!-- Mode Suggestion -->
    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Investment Mode</h2>
      <div id="mode-box" class="p-4 rounded-lg font-bold text-lg text-center bg-yellow-500 text-black">Loading...</div>
    </section>
  </div>

  <script>
    const API_KEY = "wBaK2cIhxa1C7tg5D3NpSu9CduOCbvgF"; // Replace with your real key
    const indicators = [
      { name: "S&P 500", symbol: "SPY" },
      { name: "Nasdaq 100", symbol: "QQQ" },
      { name: "Gold", symbol: "XAUUSD" },
      { name: "10Y Yield", symbol: "IEF" },
      { name: "Dollar Index", symbol: "DXY" },
      { name: "Fear & Greed Index", symbol: "fear_greed", type: "sentiment" }
    ];

    async function fetchPrice(symbol) {
      const url = `https://financialmodelingprep.com/api/v3/quote/${symbol}?apikey=${API_KEY}`;
      const res = await fetch(url);
      const json = await res.json();
      if (!Array.isArray(json) || json.length === 0) throw new Error("No data");
      return json[0].price;
    }

    async function fetchFearGreed() {
      const res = await fetch("https://api.alternative.me/fng/");
      const json = await res.json();
      return parseInt(json.data[0].value);
    }

    async function fetchAllData() {
      const data = [];
      for (const i of indicators) {
        try {
          let value = null;
          if (i.symbol === "fear_greed") {
            value = await fetchFearGreed();
          } else {
            value = await fetchPrice(i.symbol);
          }
          data.push({ ...i, value });
        } catch (err) {
          console.warn(`Error fetching ${i.name}:`, err);
          data.push({ ...i, value: "N/A" });
        }
      }
      return data;
    }

    function determineRiskType(item) {
      const { name, value } = item;
      if (value === "N/A") return "neutral";
      if (name === "S&P 500" && value < 430) return "risk-off";
      if (name === "Nasdaq 100" && value < 350) return "risk-off";
      if (name === "Gold" && value > 2200) return "risk-off";
      if (name === "10Y Yield" && value > 4.5) return "risk-off";
      if (name === "Dollar Index" && value > 105) return "risk-off";
      if (name === "Fear & Greed Index" && value < 30) return "risk-off";
      return "neutral";
    }

    function renderModeSuggestion(data) {
      const modeBox = document.getElementById("mode-box");
      const riskOffCount = data.filter(item => determineRiskType(item) === "risk-off").length;
      if (riskOffCount >= 3) {
        modeBox.textContent = 'âš ï¸ Caution: Consider Holding Cash or Rebalancing';
        modeBox.className = 'p-4 rounded-lg font-bold text-lg text-center bg-red-500 text-black';
      } else if (riskOffCount === 0) {
        modeBox.textContent = 'âœ… Market Stable: Stay Invested';
        modeBox.className = 'p-4 rounded-lg font-bold text-lg text-center bg-green-500 text-black';
      } else {
        modeBox.textContent = 'ðŸŸ¡ Neutral: Stay Informed';
        modeBox.className = 'p-4 rounded-lg font-bold text-lg text-center bg-yellow-500 text-black';
      }
    }

    async function fetchChartData(symbol) {
      const url = `https://financialmodelingprep.com/api/v3/historical-price-full/${symbol}?timeseries=30&apikey=${API_KEY}`;
      const res = await fetch(url);
      const json = await res.json();
      if (!json.historical) return null;
      return json.historical.reverse();
    }

    async function showChart(name, symbol) {
      const section = document.getElementById("chart-section");
      const title = document.getElementById("chart-title");
      const canvas = document.getElementById("chart-canvas");
      section.classList.remove("hidden");
      title.textContent = `${name} - Past 30 Days`;

      const data = await fetchChartData(symbol);
      if (!data) return;

      const ctx = canvas.getContext("2d");
      if (window.chart) window.chart.destroy();

      window.chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.map(d => d.date),
          datasets: [{
            label: name,
            data: data.map(d => d.close),
            backgroundColor: "rgba(255, 255, 255, 0.1)",
            borderColor: "rgba(255, 255, 255, 0.8)",
            borderWidth: 2,
            pointRadius: 0,
            fill: true,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: "#fff" } }
          },
          scales: {
            x: { ticks: { color: "#aaa" } },
            y: { ticks: { color: "#aaa" } }
          }
        }
      });
    }

    function renderAlerts(data) {
      const container = document.getElementById("alert-cards");
      container.innerHTML = "";
      data.forEach(item => {
        const riskType = determineRiskType(item);
        const bg = riskType === 'risk-off' ? 'bg-red-500' : 'bg-yellow-500';
        const value = item.value === "N/A" ? "N/A" : item.value.toLocaleString();

        const card = document.createElement("div");
        card.className = `p-4 rounded-lg text-black cursor-pointer ${bg}`;
        card.innerHTML = `<div class="text-sm font-bold">${item.name}</div>
                          <div class="text-xl">${value}</div>`;

        if (item.symbol !== "fear_greed" && item.value !== "N/A") {
          card.onclick = () => showChart(item.name, item.symbol);
        }

        container.appendChild(card);
      });

      renderModeSuggestion(data);
    }

    async function fetchNews() {
      try {
        const res = await fetch("https://finnhub.io/api/v1/news?category=general&token=d1482k1r01qrqeasm27gd1482k1r01qrqeasm280");
        const articles = await res.json();
        return Array.isArray(articles) ? articles.slice(0, 5) : [];
      } catch (err) {
        console.error("News error", err);
        return [];
      }
    }

    function renderNews(articles) {
      const list = document.getElementById("news-list");
      list.innerHTML = "";
      articles.forEach(article => {
        const li = document.createElement("li");
        li.classList.add("mb-1");
        li.innerHTML = `<a href="${article.url}" class="underline hover:text-yellow-300" target="_blank">${article.headline}</a>`;
        list.appendChild(li);
      });
    }

    async function initDashboard() {
      const data = await fetchAllData();
      renderAlerts(data);
      const news = await fetchNews();
      renderNews(news);
    }

    initDashboard();
  </script>
</body>
</html>
