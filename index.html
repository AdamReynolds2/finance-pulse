<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finance Pulse</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">üìä Finance Pulse</h1>

    <!-- Market Alerts -->
    <section id="alerts" class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Market Pulse Alerts</h2>
      <div class="grid grid-cols-2 gap-4" id="alert-cards"></div>
    </section>

    <!-- News Headlines -->
    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Latest Market Headlines</h2>
      <ul id="news-list" class="list-disc list-inside text-sm space-y-1"></ul>
    </section>

    <!-- Mode Suggestion -->
    <section class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Investment Mode</h2>
      <div id="mode-box" class="p-4 rounded-lg font-bold text-lg text-center bg-yellow-500 text-black">Loading...</div>
    </section>
  </div>

  <script>
    const symbols = [
      { name: 'S&P 500 (SPY)', symbol: 'SPY' },
      { name: 'Nasdaq 100 (QQQ)', symbol: 'QQQ' },
      { name: '10Y Bond (IEF)', symbol: 'IEF' },
      { name: 'Gold (XAUUSD=X)', symbol: 'XAUUSD=X' },
      { name: 'Dollar Index (DXY)', symbol: 'DX-Y.NYB' },
      { name: 'Bitcoin', symbol: 'bitcoin', isCrypto: true },
    ];

    async function fetchData() {
      const yahooSymbols = symbols.filter(s => !s.isCrypto).map(s => s.symbol).join(',');
      const proxyUrl = `https://corsproxy.io/?https://query1.finance.yahoo.com/v7/finance/quote?symbols=${yahooSymbols}`;
      let data = [];

      try {
        const res = await fetch(proxyUrl);
        const json = await res.json();
        if (json.quoteResponse && json.quoteResponse.result) {
          data = json.quoteResponse.result.map(item => {
            const match = symbols.find(s => s.symbol === item.symbol);
            return {
              name: match.name,
              value: item.regularMarketPrice,
              change: item.regularMarketChangePercent,
              symbol: item.symbol,
            };
          });
        }
      } catch (err) {
        console.error('Yahoo fetch error:', err);
      }

      // Add Bitcoin from CoinGecko
      try {
        const btcRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
        const btcJson = await btcRes.json();
        const btcPrice = btcJson.bitcoin.usd;
        data.push({ name: 'Bitcoin', value: btcPrice, change: null, symbol: 'bitcoin' });
      } catch (err) {
        console.error('CoinGecko fetch error:', err);
      }

      return data;
    }

    function determineRiskType(name, value) {
      if (name.includes('SPY') && value < 430) return 'risk-off';
      if (name.includes('QQQ') && value < 360) return 'risk-off';
      if (name === 'Bitcoin' && value < 30000) return 'risk-off';
      if (name.includes('Gold') && value > 2100) return 'risk-off';
      if (name.includes('10Y') && value < 90) return 'risk-off';
      if (name.includes('Dollar') && value > 105) return 'risk-off';
      return 'neutral';
    }

    function renderLiveAlerts(data) {
      const container = document.getElementById('alert-cards');
      container.innerHTML = '';
      data.forEach(a => {
        const riskType = determineRiskType(a.name, a.value);
        const bg = riskType === 'risk-off' ? 'bg-red-500' :
                   riskType === 'risk-on' ? 'bg-green-500' : 'bg-yellow-500';
        container.innerHTML += `<div class="p-4 rounded-lg ${bg} text-black">
          <div class="text-sm font-bold">${a.name}</div>
          <div class="text-xl">${a.value ? a.value.toLocaleString() : 'N/A'}</div>
        </div>`;
      });

      renderModeSuggestion(data);
    }

    function renderModeSuggestion(alerts) {
      const modeBox = document.getElementById('mode-box');
      const riskOffCount = alerts.filter(a => determineRiskType(a.name, a.value) === 'risk-off').length;
      if (riskOffCount >= 4) {
        modeBox.textContent = '‚ö†Ô∏è Market Warning: Consider Rebalancing or Holding Cash';
        modeBox.className = 'p-4 rounded-lg font-bold text-lg text-center bg-red-500 text-black';
      } else if (riskOffCount <= 1) {
        modeBox.textContent = '‚úÖ Market Appears Stable: Stay Invested';
        modeBox.className = 'p-4 rounded-lg font-bold text-lg text-center bg-green-500 text-black';
      } else {
        modeBox.textContent = 'üü° Mixed Signals: Stay Informed';
        modeBox.className = 'p-4 rounded-lg font-bold text-lg text-center bg-yellow-500 text-black';
      }
    }

    async function fetchNews() {
      try {
        const res = await fetch('https://finnhub.io/api/v1/news?category=general&token=d1482k1r01qrqeasm27gd1482k1r01qrqeasm280');
        const articles = await res.json();
        return articles.slice(0, 5);
      } catch (err) {
        console.error('News fetch error:', err);
        return [];
      }
    }

    function renderNewsHeadlines(articles) {
      const list = document.getElementById('news-list');
      list.innerHTML = '';
      articles.forEach(article => {
        const li = document.createElement('li');
        li.classList.add('mb-1');
        li.innerHTML = `<a href="${article.url}" class="underline hover:text-yellow-300" target="_blank">${article.headline}</a>`;
        list.appendChild(li);
      });
    }

    async function initDashboard() {
      const data = await fetchData();
      renderLiveAlerts(data);
      const news = await fetchNews();
      renderNewsHeadlines(news);
    }

    initDashboard();
  </script>
</body>
</html>
